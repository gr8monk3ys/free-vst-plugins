name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly to check if download URLs are still valid
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  lint:
    name: Lint & Validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate JSON
        run: python -m json.tool plugins.json > /dev/null

      - name: Lint Python script
        run: |
          pip install ruff
          ruff check scripts/download-plugins.py || true

      - name: Check script syntax
        run: python -m py_compile scripts/download-plugins.py

  test-script:
    name: Test Script (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.9', '3.11', '3.12']
        exclude:
          # Only test all Python versions on Ubuntu
          - os: macos-latest
            python-version: '3.9'
          - os: macos-latest
            python-version: '3.12'
          - os: windows-latest
            python-version: '3.9'
          - os: windows-latest
            python-version: '3.12'

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Test --help
        run: python scripts/download-plugins.py --help

      - name: Test --list
        run: python scripts/download-plugins.py --list

      - name: Test platform detection
        run: |
          python -c "
          import platform
          system = platform.system().lower()
          expected = {'darwin': 'macos', 'windows': 'windows', 'linux': 'linux'}
          detected = expected.get(system, system)
          print(f'Detected platform: {detected}')
          assert detected in ['macos', 'windows', 'linux'], f'Unknown platform: {detected}'
          "

  check-urls:
    name: Validate Plugin URLs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check URLs are reachable
        run: |
          python << 'EOF'
          import json
          import urllib.request
          import urllib.error
          import sys

          with open('plugins.json', 'r') as f:
              data = json.load(f)

          failed = []
          checked = 0

          def check_url(name, url, platform):
              global checked, failed
              if not url or url == 'github-api':
                  return

              checked += 1
              try:
                  req = urllib.request.Request(url, method='HEAD', headers={
                      'User-Agent': 'Mozilla/5.0 (compatible; CI-Check/1.0)'
                  })
                  with urllib.request.urlopen(req, timeout=30) as resp:
                      print(f"✓ {name} ({platform}): {resp.status}")
              except urllib.error.HTTPError as e:
                  if e.code in [403, 405]:  # Some servers don't allow HEAD
                      print(f"~ {name} ({platform}): {e.code} (may still work)")
                  else:
                      print(f"✗ {name} ({platform}): HTTP {e.code}")
                      failed.append(f"{name} ({platform}): HTTP {e.code}")
              except Exception as e:
                  print(f"✗ {name} ({platform}): {e}")
                  failed.append(f"{name} ({platform}): {e}")

          for category in data.get('plugins', {}).values():
              for plugin in category:
                  name = plugin.get('name', 'Unknown')
                  urls = plugin.get('urls', {})

                  for platform, url_info in urls.items():
                      if isinstance(url_info, dict):
                          url = url_info.get('url')
                      else:
                          url = url_info
                      check_url(name, url, platform)

          print(f"\n{checked} URLs checked, {len(failed)} failed")

          if failed:
              print("\nFailed URLs:")
              for f in failed:
                  print(f"  - {f}")
              # Don't fail the build for URL issues (they may be temporary)
              # sys.exit(1)
          EOF

  docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: free-vst-plugins:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test Docker image
        run: |
          docker run --rm free-vst-plugins:test --list
          docker run --rm free-vst-plugins:test --help

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [lint, test-script, docker]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Get version from plugins.json
        id: version
        run: |
          VERSION=$(python -c "import json; print(json.load(open('plugins.json'))['meta']['version'])")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Check if tag exists
        id: check_tag
        run: |
          if git rev-parse "v${{ steps.version.outputs.version }}" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        if: steps.check_tag.outputs.exists == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }}
          body: |
            ## Free VST Plugins v${{ steps.version.outputs.version }}

            Cross-platform downloader for free VST plugins.

            ### Usage
            ```bash
            git clone https://github.com/gr8monk3ys/free-vst-plugins.git
            cd free-vst-plugins
            python3 scripts/download-plugins.py
            ```

            Or with Docker:
            ```bash
            docker run -v ~/Downloads/VST-Plugins:/downloads ghcr.io/gr8monk3ys/free-vst-plugins
            ```
          generate_release_notes: true
